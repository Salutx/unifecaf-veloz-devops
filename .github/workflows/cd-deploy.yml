name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI - Build and Push Images"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/base/

          # Rolling update
          kubectl rollout restart deployment/pedidos -n loja-veloz
          kubectl rollout restart deployment/pagamentos -n loja-veloz
          kubectl rollout restart deployment/estoque -n loja-veloz
          kubectl rollout restart deployment/api-gateway -n loja-veloz

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/pedidos -n loja-veloz --timeout=3m
          kubectl rollout status deployment/pagamentos -n loja-veloz --timeout=3m
          kubectl rollout status deployment/estoque -n loja-veloz --timeout=3m
          kubectl rollout status deployment/api-gateway -n loja-veloz --timeout=3m

      - name: Verify deployment
        run: |
          kubectl get pods -n loja-veloz
          kubectl get svc -n loja-veloz
