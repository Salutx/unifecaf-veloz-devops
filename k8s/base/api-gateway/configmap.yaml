apiVersion: v1
kind: ConfigMap
metadata:
  name: api-gateway-nginx-config
  namespace: loja-veloz
data:
  default.conf: |
    upstream pedidos_backend {
        server pedidos-service.loja-veloz.svc.cluster.local:8080;
    }

    upstream pagamentos_backend {
        server pagamentos-service.loja-veloz.svc.cluster.local:8080;
    }

    upstream estoque_backend {
        server estoque-service.loja-veloz.svc.cluster.local:8080;
    }

    server {
        listen 8080;
        server_name _;
        
        root /usr/share/nginx/html;
        index index.html;

        # Health check do API Gateway
        location = /health {
            access_log off;
            return 200 '{"status":"healthy","service":"api-gateway","version":"1.0.0"}\n';
            add_header Content-Type application/json;
        }

        # Metrics do API Gateway
        location = /metrics {
            stub_status on;
            access_log off;
        }

        # Serviço de Pedidos
        location /api/pedidos/ {
            rewrite ^/api/pedidos/(.*) /$1 break;
            proxy_pass http://pedidos_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Serviço de Pagamentos
        location /api/pagamentos/ {
            rewrite ^/api/pagamentos/(.*) /$1 break;
            proxy_pass http://pagamentos_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Serviço de Estoque
        location /api/estoque/ {
            rewrite ^/api/estoque/(.*) /$1 break;
            proxy_pass http://estoque_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Página inicial e outros arquivos estáticos
        location / {
            try_files $uri $uri/ /index.html =404;
        }
    }
